version: "3.8"

# Docker Compose two-container mode:
#   - discord-voice-assistant: Python bot (STT, LLM, TTS pipeline)
#   - voice-bridge: Node.js voice I/O with DAVE E2EE
#
# For Unraid / single-container deployments, use the Docker image directly
# (it embeds the voice bridge). See unraid-template.xml.
#
# Multiple instances on the same machine:
#   Each instance needs its own project name, .env, and data directories.
#   Run from separate directories or use -p to set a project name:
#     docker compose -p bot1 --env-file bot1.env up -d
#     docker compose -p bot2 --env-file bot2.env up -d
#   Each .env must have a unique DISCORD_BOT_TOKEN and OPENCLAW_URL.

services:
  discord-voice-assistant:
    # Use the pre-built image from GHCR (recommended):
    image: ghcr.io/dracoc77/openclaw_discord_voice_assistant:latest
    # Or build locally by uncommenting the next line:
    # build: .
    restart: unless-stopped
    # In two-container mode, run only the Python bot (not the embedded bridge)
    command: ["python", "-m", "discord_voice_assistant.main"]
    env_file: ${ENV_FILE:-.env}
    environment:
      - TZ=${TZ:-America/New_York}
      - DATA_DIR=/app/data
      - MODELS_DIR=/app/models
      # Point to the separate voice-bridge container
      - VOICE_BRIDGE_URL=ws://voice-bridge:9876
    volumes:
      # Persistent data (override DATA_PATH for multi-instance)
      - ${DATA_PATH:-./data}:/app/data
      # Model cache (Whisper models, wake word models, TTS models)
      - ${MODELS_PATH:-./models}:/app/models
      # Logs
      - ${LOGS_PATH:-./logs}:/app/logs
    # For Unraid, these paths map to /mnt/user/appdata/discord-voice-assistant/*
    # See unraid-template.xml for Unraid-specific configuration
    depends_on:
      voice-bridge:
        condition: service_started

    # Resource limits (adjust based on STT model size)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import discord_voice_assistant; print('ok')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  voice-bridge:
    build: ./voice_bridge
    restart: unless-stopped
    environment:
      - BRIDGE_PORT=9876
      - HEALTH_PORT=9877
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:9877/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
